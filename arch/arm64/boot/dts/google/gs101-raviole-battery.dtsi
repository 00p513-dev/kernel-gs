// SPDX-License-Identifier: GPL-2.0-only
/*
 * Battery device tree entries specific to raviole
 *
 * Copyright 2020 Google,LLC
 *
 */

/ {
	fragment@battery {
		target-path = "/";
		__overlay__ {

			google_battery: google,battery {
				status = "okay";
				compatible = "google,battery";
				#cooling-cells = <2>;
				google,fg-psy-name = "maxfg";

				/* charge table */
				google,chg-temp-limits = <0 100 200 420 460 480 550>;
				google,chg-cv-limits = <4200000 4300000 4450000>;
				google,chg-cc-limits = <
				 30  10   0
				 50  30  30
				100  70  50
				 80  50  50
				 50  50   0
				 30   0   0
				>;

				google,ttf-temp-idx= <2>;
				google,ttf-adapter = <1800>;
				google,ttf-soc-table =  <49 59 72 78 93 95  98 100>;
				google,ttf-elap-table = <45 52 56 67 78 91 104 120>;
				google,ttf-tier-table = <0 71 78>;

				/* IRDrop Compensation */
				google,fv-uv-resolution = <10000>;
				/* NOTE: high value for DC charging */
				google,fv-uv-margin-dpct = <1025>;
				/* tier switch */
				google,cv-range-accuracy = <20000>;
				google,cv-otv-margin = <12000>;
				google,cv-debounce-cnt = <3>;
				google,cv-tier-ov-cnt = <10>;
				google,cv-tier-switch-cnt = <3>;

				#thermal-sensor-cells = <0>;
			};

			google_cpm: google,cpm {
				status = "okay";
				compatible = "google,cpm";
				google,chg-power-supplies = "main-charger",
							    "pca9468-mains";

				/* S2MPG10X01 -> GPIO_1 -> CHARGE_PUMP_EN */
				google,dc-en = <&s2mpg10_gpio 1 0>;
				/* DC enabled by default */
				google,dc-en-value = <1>;
				google,dc_limit-demand = <10012500>;
				google,dc_limit-vbatt = <4350000>;

				google,tcpm-power-supply = <&max77759tcpc>;
				google,wlc_dc-power-supply = "wireless";
				google,pps-awake;
			};

			google_charger: google,charger {
				status = "okay";
				compatible = "google,charger";
				#cooling-cells = <2>;

				google,chg-power-supply = "gcpm";
				google,bat-power-supply = "battery";
				google,usb-power-supply = "usb";

				google,fv-max-uv = <4450000>;

				google,thermal-mitigation = <4000000 3000000
							2000000 1000000 500000>;
				google,wlc-thermal-mitigation = <1100000 500000 250000 110000>;
				google,therm-wlc-overrides-fcc;
			};

			google_bms {
				nvmem = <&pack_bee>;
			};

		};
	};
};

&pinctrl_0 {
/* [MAX77759: FG_INTB] > FG_INT_L > [XEINT_23 : SC59845XWE] */
	if_pmic_fg_irq: if-pmic-fg-irq {
		samsung,pins = "gpa9-3"; /* XEINT_23 */
		samsung,pin-function = <EXYNOS_PIN_FUNC_EINT>;
		samsung,pin-pud = <EXYNOS_PIN_PULL_UP>;
		samsung,pin-drv = <GS101_PIN_DRV_2_5_MA>;
	};
};

&pinctrl_1 {
/* [MAX77729FEWN : INTB] > IF_PMIC_IRQ_L > [XEINT_15 : SC59845XWE] */
	if_pmic_irq: if-pmic-irq {
		samsung,pins = "gpa8-3";
		samsung,pin-function = <EXYNOS_PIN_FUNC_EINT>;
		samsung,pin-pud = <EXYNOS_PIN_PULL_UP>;
		samsung,pin-drv = <GS101_PIN_DRV_2_5_MA>;
	};

	dc_charger_irq: dc-charger-irq {
		samsung,pins = "gpa6-0"; /* XEINT_0 (PLC_INT_L) */
		samsung,pin-function = <EXYNOS_PIN_FUNC_EINT>;
		samsung,pin-pud = <EXYNOS_PIN_PULL_NONE>;
	};
};

&hsi2c12_bus {
	samsung,pins = "gpp23-4", "gpp23-5";
	samsung,pin-pud = <EXYNOS_PIN_PULL_UP>;
};

&hsi2c_8 {
	#address-cells = <1>;
	#size-cells = <0>;
	status = "okay";

	pinctrl-names = "default";
	pinctrl-0 = <&hsi2c8_bus>;

	pack_bee: m24c08@50 {
		status = "okay";
		compatible = "at,24c08";

		reg = <0x50>;
	};
};

&hsi2c_12 {

	#address-cells = <1>;
	#size-cells = <0>;
	status = "okay";
	clock-frequency = <400000>;

	/* also as max77759 pmic  */
	max77729_pmic:max77729pmic@0x66 {
		status = "okay";
		compatible = "maxim,max77729pmic";
		reg = <0x66>;

		pinctrl-names = "default";
		pinctrl-0 = <&if_pmic_irq>;
		max777x9,irq-gpio = <&gpa8 3 GPIO_ACTIVE_LOW>;

		max77759,max_m5 = <&max77759_fg>;

		max777x9_gpio: max777x9_gpio {
			gpio-controller;
			#gpio-cells = <2>;
			ngpios = <6>;
		};
	};

	max77759_fg:max77759fg@0x36 {
		status = "okay";
		compatible = "maxim,max77759";
		reg = <0x36>;

		/* FG_INT_L -> XEINT_23 */
		pinctrl-names = "default";
		pinctrl-0 = <&if_pmic_fg_irq>;
		maxim,irq-gpio = <&gpa9 3 GPIO_ACTIVE_LOW>;

		maxim,gauge-type = <2>;
		maxim,rsense-default = <500>;

		/* no needed for EEPROM */
		maxim,batt-id-range-pct = <0>;

		maxim,psy-type-unknown;
	};

	max77759_chg:max77759chrg@0x69 {
		status = "okay";
		compatible = "maxim,max77759chrg";
		reg = <0x69>;

		interrupt-parent = <&gpa8>;
		max77759,irq-gpio = <&gpa8 3 GPIO_ACTIVE_LOW>;
		max77759,psy-name = "main-charger";

		max77759,max_m5 = <&max77759_fg>;
		max77759,pmic = <&max77729_pmic>;

		#thermal-sensor-cells = <1>;

		/* system use cases */
		max77759,bst-on = <&max777x9_gpio 4 GPIO_ACTIVE_HIGH>;
		max77759,bst-sel = <&s2mpg10_gpio 3 GPIO_ACTIVE_HIGH>;
		max77759,extbst-ctl = <&max77759_tcpc_gpio 0 GPIO_ACTIVE_HIGH>;
		max77759,ls2-en = <&max20339_gpio 1 GPIO_ACTIVE_HIGH>;
		max77759,sw-en = <&max20339_gpio 4 GPIO_ACTIVE_HIGH>;
		max77759,lsw1-is_open = <&max20339_gpio 5 GPIO_ACTIVE_HIGH>;
		max77759,lsw1-is_closed = <&max20339_gpio 6 GPIO_ACTIVE_HIGH>;
		max77759,vin-is_valid =  <&max20339_gpio 3 GPIO_ACTIVE_HIGH>;

		max77759,cpout-en =  <&p9412_gpio 1 GPIO_ACTIVE_HIGH>;
		max77759,cpout-ctl =  <&p9412_gpio 3 GPIO_ACTIVE_HIGH>;
	};

	pca9468_dc: pca9468@57 {
		compatible = "nxp,pca9468";
		reg = <0x57>;

		pinctrl-names = "default";
		pinctrl-0 = <&dc_charger_irq>;

		interrupt-parent = <&gpa6>;
		pca9468,irq-gpio = <&gpa6 0 GPIO_ACTIVE_LOW>; /* PLC_INT_L */

		pca9468,float-voltage = <4300000>; /* 4.3V */

		pca9468,input-itopoff = <500000>; /* 500mA */
		pca9468,sense-resistance = <0>; /* 5mOhm */
		pca9468,switching-frequency = <3>; /* 980KHz */

		/* disable USBC NTC */
		pca9468,ntc-threshold = <0>; /* disabled */

		/* USBC thermal zone */
		google,usb-port-tz-name = "usbc-therm-adc";

		pca9468,google_cpm = <&google_cpm>;
	};

};


